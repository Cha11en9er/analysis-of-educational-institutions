# Отчёт по проекту "Анализ образовательных учреждений Саратова"

## Введение

Проект предназначен для сбора, обработки и анализа данных об образовательных учреждениях города Саратова из различных источников (2GIS, Яндекс Карты, uchi.ru). Реализован полный цикл работы с данными: от автоматизированного парсинга до анализа отзывов и визуализации результатов.

---

## 1. Технологии и структура проекта

**Основные технологии:**
- Python 3.7+, Selenium, BeautifulSoup4, requests — для парсинга
- pandas, numpy — для обработки данных
- sentence-transformers, scikit-learn — для объединения данных и анализа
- folium, matplotlib, seaborn — для визуализации
- Yandex Geocoding API — для получения координат

**Структура проекта:**
```
parsing/          # Парсинг данных из 2GIS, Яндекс Карт
geocoding/        # Геокодирование адресов
recognize_meaning/# Анализ тональности отзывов
visualization/    # Визуализация на карте
json_to_excel/    # Экспорт в Excel
global_data/      # Итоговые данные
```

---

## 2. Сбор данных

### 2.1 Парсинг из 2GIS

Парсинг выполняется в два этапа: сначала собирается список всех школ (18 страниц), затем для каждой школы извлекается детальная информация.

Для работы с динамическим контентом используется Selenium с настройками обхода детекции:

```python
chrome_options = Options()
chrome_options.add_argument("--disable-blink-features=AutomationControlled")
chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
```

Для загрузки всех элементов используется прокрутка страницы:

```python
def scroll_to_load_all(self):
    for i in range(150):
        containers = self.driver.find_elements(By.CSS_SELECTOR, "div._zjunba")
        if len(containers) == last_count:
            break
        pyautogui.scroll(-5)
        time.sleep(0.2)
```

### 2.2 Пример данных о школе

```json
{
    "id": "2",
    "yandex_name": "Средняя общеобразовательная школа № 77",
    "2gis_full_name": "МОУ Средняя общеобразовательная школа №77",
    "2gis_url": "https://2gis.ru/saratov/firm/6052240280256857",
    "ym_url": "https://yandex.com/maps/org/secondary_school_77/1028265778/",
    "ym_adres": "Саратов, Шелковичная улица, 141",
    "cadastral_number": "64:48:000000:1988",
    "geocoords": "(51.536868, 45.983313)",
    "2gis_rating": 4.1,
    "ym_rating": 3.8
}
```

---

## 3. Объединение данных

### 3.1 Нормализация названий и адресов

Для объединения данных из разных источников используется нормализация названий и адресов:

```python
RE_MOVER = re.compile(r'\b(моу|маоу|гоу|гбоу|фгоу|фгбоу|чоу|аноо|мкоу|мбоу|гапоу|гаоу|мау)\b', re.I)

def norm(s: str) -> str:
    """Привести строку к нижнему регистру без лишних пробелов и без МОУ/МАОУ/…"""
    if not s:
        return ''
    s = RE_MOVER.sub(' ', s)  # вырезаем тип учреждения
    s = re.sub(r'[^а-яё0-9\s]', ' ', s)  # оставляем только русские буквы и цифры
    return re.sub(r'\s+', ' ', s).strip().lower()

def norm_addr(raw: str) -> str:
    """Унифицировать адрес: убрать «Саратов,», индексы, лишние пробелы."""
    raw = re.sub(r'\([^)]*\)', ' ', raw)
    raw = re.sub(r'\b\d{6}\b', ' ', raw)  # удаляем индексы
    raw = re.sub(r'\b(г\.?|город)\s+саратов\b', ' ', raw, flags=re.I)
    return re.sub(r'\s+', ' ', raw).strip().lower()
```

Алгоритм объединения: сначала по нормализованным адресам, затем по названиям, оставшиеся добавляются как отдельные записи.

### 3.2 Векторизация текста

Альтернативный подход — использование векторизации через sentence-transformers:

```python
from sentence_transformers import SentenceTransformer
from sklearn.metrics.pairwise import cosine_similarity

model = SentenceTransformer("sentence-transformers/all-mpnet-base-v2")
emb1 = model.encode([prepare_text(x) for x in data1])
emb2 = model.encode([prepare_text(x) for x in data2])

sims = cosine_similarity(vec1, emb2)[0]
if sims[best_idx] > 0.78:  # порог подбора
    # Объединяем записи
```

---

## 4. Геокодирование адресов

Для получения координат используется Yandex Geocoding API:

```python
def geocode_address(address):
    base_url = f'https://geocode-maps.yandex.ru/1.x/'
    params = {
        'apikey': API_KEY,
        'format': 'json',
        'geocode': address
    }
    response = requests.get(base_url, params=params)
    data = response.json()
    coordinates = data['response']['GeoObjectCollection']['featureMember'][0]['GeoObject']['Point']['pos'].split()
    latitude, longitude = float(coordinates[1]), float(coordinates[0])
    return {'latitude': latitude, 'longitude': longitude}
```

---

## 5. Анализ отзывов

### 5.1 Определение тональности

Система определяет тональность отзывов на основе словарей положительных/отрицательных слов и рейтинга отзыва:

```python
def recognize_review_free(review_text, rating=None):
    review_lower = review_text.lower()
    topics = {}
    
    # Извлекаем темы и их тональность
    for category, keywords in THEME_CATEGORIES.items():
        found_keywords = []
        for kw in keywords:
            pattern = r'(?:^|[^а-яё])' + re.escape(kw) + r'[а-яё]*(?=[^а-яё]|$)'
            if re.search(pattern, review_lower):
                found_keywords.append(kw)
        
        if found_keywords:
            # Анализируем контекст
            sentences = re.split(r'[.!?]\s+', review_text)
            relevant_sentences = [s for s in sentences if any(kw in s.lower() for kw in found_keywords)]
            
            if relevant_sentences:
                context_text = ' '.join(relevant_sentences)
                sentiment = analyze_text_sentiment(context_text)
                
                # Корректируем на основе rating
                if rating is not None:
                    if int(rating) <= 2:
                        topic_sentiment = "neg"
                    elif int(rating) >= 4:
                        topic_sentiment = "pos"
                
                topics[category] = topic_sentiment
    
    return {"topics": topics, "overall": overall}
```

### 5.2 Категории тем

Определены 8 категорий: учителя, еда, ремонт, администрация, буллинг, инфраструктура, охрана, уборка.

### 5.3 Примеры отзывов

**Положительный отзыв:**
```json
{
    "review_id": "1",
    "school_id": "2",
    "date": "2015-11-26",
    "text": "Проучилась в ней не долго (2007-2010), но в памяти особенно важные люди остались на всю жизнь. Огромное спасибо заучу Олейниковой Светлане Валентиновне...",
    "rating": 5,
    "topics": {
        "учителя": "pos",
        "администрация": "pos"
    },
    "overall": "pos"
}
```

**Отрицательный отзыв:**
```json
{
    "review_id": "5",
    "school_id": "2",
    "date": "2021-08-21",
    "text": "Очень не рекомендую учительницу начальных классов Медведеву Наталью Анатольевну. Столкнулись с травлей со стороны учителя...",
    "rating": 2,
    "topics": {
        "учителя": "neg",
        "буллинг": "neg"
    },
    "overall": "neg"
}
```

### 5.4 Агрегация метрик

Для каждой школы вычисляются метрики:
- `topic_cnt_<topic>` — количество отзывов по теме
- `topic_neg_share_<topic>` — доля негативных отзывов (0.0-1.0)
- `topic_sentiment_<topic>` — средняя тональность (-1.0 до +1.0)

Пример метрик:
```json
{
    "school_id": "2",
    "topic_учителя_cnt": 25,
    "topic_учителя_neg_share": 0.08,
    "topic_учителя_sentiment": 0.84,
    "topic_еда_cnt": 12,
    "topic_еда_neg_share": 0.33,
    "topic_еда_sentiment": -0.33
}
```

---

## 6. Визуализация

Создана интерактивная карта школ с использованием Folium:

```python
import folium

map_schools = folium.Map(location=(avg_lat, avg_lon), zoom_start=12)

for school_data, coords in valid_schools:
    folium.Marker(
        location=coords,
        popup=folium.Popup(popup_html, max_width=300),
        tooltip=name
    ).add_to(map_schools)

map_schools.save('school_map.html')
```

---

## 7. Итоговые результаты

**Собранные данные:**
- 208 школ из 2GIS + данные из Яндекс Карт
- Несколько тысяч отзывов за период 2015-2025 годов
- Географические координаты для большинства школ
- Кадастровые номера для части зданий

**Созданные файлы:**
- `school_merge_data.json` — объединённый датасет школ
- `2gis_school_reviews.json`, `ym_review_output.json` — отзывы с анализом
- `schools_output.xlsx`, `schools_reviews.xlsx` — таблицы Excel
- `school_map.html` — интерактивная карта

**Метрики:**
- 8 тем категоризации
- 24 метрики на школу (3 типа × 8 тем)
- Годовые разбивки (2022-2025)

---

## Заключение

Проект реализовал комплексный подход к сбору, обработке и анализу данных об образовательных учреждениях Саратова. Использование нескольких источников данных и методов обработки естественного языка позволило создать единую базу данных с метриками качества по различным аспектам. Созданные датасеты могут быть использованы для принятия решений в сфере образования, мониторинга качества услуг и сравнительного анализа школ.
