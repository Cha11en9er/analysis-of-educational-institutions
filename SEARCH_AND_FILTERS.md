# Поиск и фильтрация школ: реализация и оптимизация

## 1. Реализация поиска

### Текущее состояние

- На фронте строка поиска отправляется на бэк в query-параметре `search`.
- В API эндпоинте `/api/schools/map` поиск реализован как **ILIKE по трём полям**:
  - `name_2gis`
  - `name_ym`
  - `school_address`

То есть школа попадает в выборку, если подстрока пользователя встречается в любом из этих полей (без учёта регистра).

### Как развивать поиск

1. **Расширить поля**
   - Добавить поиск по другим текстовым полям (например, `building_type`, `material`), если они есть в форме поиска.

2. **Морфология и стоп-слова (русский язык)**
   - Подключить расширение **pg_trgm** (триграммы) для нечёткого поиска:
     ```sql
     CREATE EXTENSION IF NOT EXISTS pg_trgm;
     CREATE INDEX idx_school_name_2gis_gin ON sa.school USING gin(name_2gis gin_trgm_ops);
     CREATE INDEX idx_school_name_ym_gin ON sa.school USING gin(name_ym gin_trgm_ops);
     CREATE INDEX idx_school_address_gin ON sa.school USING gin(school_address gin_trgm_ops);
     ```
   - Для полноценной морфологии (окончания, основы) можно использовать **rum** или поиск через внешний поисковый движок (Elasticsearch/OpenSearch).

3. **Полнотекстовый поиск (PostgreSQL)**
   - Добавить в таблицу `sa.school` колонку `tsvector` и индекс GIN по ней; заполнять из `name_2gis`, `name_ym`, `school_address`.
   - В API строить запрос с `to_tsquery`/`plainto_tsquery` и фильтровать по `@@`.

4. **Подсветка и ранжирование**
   - При полнотекстовом поиске можно возвращать `ts_headline()` для подсветки и `ts_rank()` для сортировки по релевантности.

5. **Автодополнение**
   - Отдельный эндпоинт типа `GET /api/schools/suggest?q=...` с `LIMIT 10` и ILIKE/триграммами по началу строки — для выпадающих подсказок при вводе.

---

## 2. Оптимизация фильтрации

### Индексы БД

- **Год постройки:**  
  `CREATE INDEX idx_school_year_built ON sa.school(year_built);`
- **Рейтинг:** рейтинг в `sa.rating`, связь по `school_id`. Уже есть уникальный индекс на `school_id`. Дополнительно:  
  `CREATE INDEX idx_rating_yandex ON sa.rating(rating_yandex);`
- **Спортобъекты (булевы поля):**  
  `CREATE INDEX idx_school_has_pool ON sa.school(has_pool) WHERE has_pool = true;`  
  Аналогично для `has_stadium`, `has_sports_ground`, `has_sports_complex` (partial index по `WHERE has_* = true` уменьшает размер индекса).
- **Поиск (если используете ILIKE):** см. выше про `pg_trgm` и GIN-индексы по текстовым полям.

### Построение запроса на бэкенде

- Собирать условия динамически только по переданным параметрам (как сейчас).
- Избегать `OR` по разным столбцам без индексов — лучше несколько условий `AND`.
- Рейтинг: оставлять `LEFT JOIN sa.rating` и фильтровать по `rating_yandex`; школы без рейтинга при `rating_min/max` не попадут (это ожидаемо). Если нужно включать школы без рейтинга — явно описать в логике: например, `(r.rating_yandex IS NULL OR r.rating_yandex BETWEEN ...)`.

### Пагинация и объём ответа

- Если школ много, не отдавать все разом:
  - Добавить `limit`/`offset` или курсор по `school_id`.
  - Для карты можно отдавать только `school_id`, `name_2gis`, `name_ym`, `school_address`, `location`, `rating_yandex` (как сейчас), без тяжёлых полей.
- При необходимости «подгрузки при зуме» — эндпоинт с границами bbox (параметры `lat_min`, `lat_max`, `lon_min`, `lon_max`) и фильтрацией через PostGIS:  
  `WHERE ST_Intersects(s.location, ST_MakeEnvelope(...))`.

### Кэширование

- Кэшировать ответы по ключу из набора параметров (search, year_min, year_max, rating_*, has_*), например в Redis, с TTL 1–5 минут, если данные не меняются в реальном времени.
- На фронте можно кэшировать последний ответ по текущей комбинации фильтров, чтобы не дергать API при повторном открытии панели без смены параметров.

### Валидация

- Год: диапазон и что `year_min <= year_max` (уже есть на бэке и можно дублировать на фронте).
- Рейтинг: 1–5 (или 0–5 в зависимости от правил), проверка `rating_min <= rating_max`.
- Булевы флаги спорта передавать только при «включённом» значении, чтобы не усложнять запрос лишними условиями.

---

## 3. Краткий чеклист

| Задача | Рекомендация |
|--------|--------------|
| Поиск по названию/адресу | ILIKE (как сейчас) + индексы pg_trgm или FTS |
| Подсказки при вводе | Отдельный эндпоинт suggest с LIMIT |
| Быстрая фильтрация | Индексы по year_built, rating_yandex, has_* |
| Большой объём данных | Пагинация или bbox для карты |
| Кэш | Redis/память по строке параметров с TTL |

Эти шаги позволяют развивать поиск и держать фильтрацию быстрой при росте числа школ.
